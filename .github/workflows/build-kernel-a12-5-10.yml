name: build-kernel-a12-5-10-226

permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  build-kernel-5-10-226:
    runs-on: ubuntu-latest

    env:
      CONFIG: android12-5.10-226
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      FIXED_TIME: "Fri Jan 24 18:48:47 UTC 2025"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git curl wget unzip build-essential bc flex bison \
            libncurses5-dev libelf-dev libssl-dev dwarves \
            clang lld ccache rsync python3

      - name: Setup ccache
        run: |
          mkdir -p "$CCACHE_DIR"
          ccache --max-size=2G
          echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV

      - name: Clone helper repos
        run: |
          git clone https://github.com/WildPlusKernel/AnyKernel3.git --depth=1
          git clone https://github.com/ITxiao6666/Unicode_bypass_Fix.git --depth=1
          git clone --depth=1 --branch gki-android12-5.10 \
            https://github.com/ShirkNeko/susfs4ksu.git

      - name: Init kernel source
        run: |
          mkdir -p "$CONFIG"
          cd "$CONFIG"
          repo init --depth=1 \
            -u https://android.googlesource.com/kernel/manifest \
            -b common-android12-5.10
          repo sync -c -j$(nproc) --no-tags

      - name: Apply Unicode patches
        run: |
          cd "$CONFIG/common"
          for p in \
            unicode-bypass_fix_5.10-6.12通用.patch \
            unicode_bypass_fix2.patch; do
            if [ -f "$GITHUB_WORKSPACE/Unicode_bypass_Fix/$p" ]; then
              if patch -p1 --dry-run < "$GITHUB_WORKSPACE/Unicode_bypass_Fix/$p"; then
                patch -p1 < "$GITHUB_WORKSPACE/Unicode_bypass_Fix/$p"
              fi
            fi
          done

      - name: Apply SUSFS (official strict patch)
        run: |
          cd "$CONFIG/common"
          PATCH="$GITHUB_WORKSPACE/susfs4ksu/kernel_patches/50_add_susfs_in_gki-android12-5.10.patch"
          patch -p1 --dry-run < "$PATCH"
          patch -p1 < "$PATCH"

          grep -q CONFIG_KSU_SUSFS arch/arm64/configs/gki_defconfig || \
            echo "CONFIG_KSU_SUSFS=y" >> arch/arm64/configs/gki_defconfig

      - name: Fix build time
        run: |
          cd "$CONFIG/common"
          if [ -f scripts/mkcompile_h ]; then
            sed -i "s|UTS_VERSION=.*|UTS_VERSION=\"#1 SMP PREEMPT $FIXED_TIME\"|" scripts/mkcompile_h || true
          fi

      - name: Build kernel
        run: |
          cd "$CONFIG"
          LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 \
            build/build.sh CC="ccache clang"

      - name: Package AnyKernel3
        run: |
          cp "$CONFIG/out/android12-5.10/dist/Image" AnyKernel3/Image
          cd AnyKernel3
          zip -r "$GITHUB_WORKSPACE/kernel-5.10.226.zip" .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-5.10.226
          path: kernel-5.10.226.zip
