name: 编译内核 a12-5-10-226 - 合并工作流

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      make_release:
        description: '是否触发 release 步骤 (未启用时仅编译)'
        required: true
        type: boolean
        default: false
      kernelsu_variant:
        description: "选择 KernelSU"
        required: true
        type: choice
        options:
          - Official
          - Next
          - MKSU
          - SukiSU
        default: SukiSU
      kernelsu_branch:
        description: "选择 ksu 分支"
        required: true
        type: choice
        options:
          - Stable(标准)
          - Dev(开发)
          - Other(其他/指定)
        default: Dev(开发)
      version:
        description: '自定义版本名(如5.10.226后面的字符/留空则使用默认版本号)'
        required: false
        type: string
      use_zram:
        description: '是否开启ZRAM相关补丁'
        required: true
        type: boolean
        default: true
      use_kpm:
        description: '是否开启KPM功能?'
        required: true
        type: boolean
        default: true
      BBG:
        description: '是否启用 Baseband-guard 支持'
        required: true
        type: boolean
        default: false

jobs:
  build-kernel-5.10.226:
    runs-on: ubuntu-latest
    env:
      SUB_LEVEL: "226"
      OS_PATCH_LEVEL: "2024-01"
      CONFIG: "android12-5.10-226"
      # 使用 github.workspace 作为更可靠的路径（替代 runner.temp）
      CCACHE_DIR: ${{ github.workspace }}/.ccache

    steps:
      - name: Checkout workflow repo (this repository)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 安装基础依赖
        run: |
          sudo apt update -y
          sudo apt install -y ccache python3 git curl wget unzip build-essential perl

      - name: 配置 ccache
        run: |
          mkdir -p "${CCACHE_DIR}"
          ccache --max-size=2G || true
          echo "CCACHE_DIR=${CCACHE_DIR}" >> $GITHUB_ENV

      - name: 恢复 ccache（缓存）
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          # 使用 env.SUB_LEVEL 替代 matrix.sub_level（无 matrix）
          key: ccache-linux-${{ env.SUB_LEVEL }}-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            ccache-linux-${{ env.SUB_LEVEL }}-${{ runner.os }}-

      - name: 下载并缓存必要工具（若无缓存）
        run: |
          mkdir -p kernel-build-tools mkbootimg || true
          if [ ! -x kernel-build-tools/linux-x86/bin/avbtool ]; then
            git clone https://android.googlesource.com/kernel/prebuilts/build-tools kernel-build-tools --depth 1 || true
          fi
          if [ ! -f mkbootimg/mkbootimg.py ]; then
            git clone https://android.googlesource.com/platform/system/tools/mkbootimg mkbootimg --depth 1 || true
          fi
          echo "AVBTOOL=$GITHUB_WORKSPACE/kernel-build-tools/linux-x86/bin/avbtool" >> $GITHUB_ENV
          echo "MKBOOTIMG=$GITHUB_WORKSPACE/mkbootimg/mkbootimg.py" >> $GITHUB_ENV
          echo "UNPACK_BOOTIMG=$GITHUB_WORKSPACE/mkbootimg/unpack_bootimg.py" >> $GITHUB_ENV

      - name: 克隆 AnyKernel3 与补丁相关仓库（最小且容错）
        run: |
          git clone https://github.com/WildPlusKernel/AnyKernel3.git --depth 1 || true
          git clone https://github.com/ShirkNeko/susfs4ksu.git --depth 1 || true
          git clone https://github.com/ShirkNeko/SukiSU_patch.git --depth 1 || true
          git clone https://github.com/ITxiao6666/Unicode_bypass_Fix.git --depth 1 || true

      - name: 初始化并同步内核源码 (common)
        run: |
          mkdir -p "$CONFIG"
          cd "$CONFIG"
          if ! command -v repo >/dev/null 2>&1; then
            curl -sLo ../git-repo-repo https://storage.googleapis.com/git-repo-downloads/repo || true
            chmod a+rx ../git-repo-repo || true
            REPO_CMD="../git-repo-repo"
          else
            REPO_CMD=repo
          fi
          $REPO_CMD init --depth=1 -u https://android.googlesource.com/kernel/manifest -b common-android12-5.10 || true
          $REPO_CMD --trace sync -c -j$(nproc --all) --no-tags --fail-fast || true
          cd ..

      - name: 应用 Unicode 补丁（仅两个指定文件）
        run: |
          PATCH_REPO="$GITHUB_WORKSPACE/Unicode_bypass_Fix"
          TARGET_COMMON="$GITHUB_WORKSPACE/${CONFIG}/common"
          echo "PATCH_REPO=${PATCH_REPO}"
          echo "TARGET_COMMON=${TARGET_COMMON}"
          if [ -d "${PATCH_REPO}" ] && [ -d "${TARGET_COMMON}" ]; then
            cd "${TARGET_COMMON}"
            for p in "unicode-bypass_fix_5.10-6.12通用.patch" "unicode_bypass_fix2.patch"; do
              if [ -f "${PATCH_REPO}/$p" ]; then
                echo "Applying patch: $p"
                patch -p1 --forward --fuzz=3 < "${PATCH_REPO}/$p" || echo "patch $p applied with warnings"
              else
                echo "Patch file not found in repo: ${PATCH_REPO}/$p"
              fi
            done
          else
            echo "Patch repo or target common dir missing; skipping unicode patch step."
            echo "PATCH_REPO exists: $( [ -d "${PATCH_REPO}" ] && echo yes || echo no )"
            echo "TARGET_COMMON exists: $( [ -d "${TARGET_COMMON}" ] && echo yes || echo no )"
          fi

      - name: 配置 KernelSU 分支选择（保持原逻辑）
        run: |
          branch_input="${{ inputs.kernelsu_branch }}"
          variant_input="${{ inputs.kernelsu_variant }}"
          BRANCH_ARG=""
          case "$branch_input" in
            "Stable(标准)")
              BRANCH_ARG="-s builtin"
              ;;
            "Dev(开发)")
              if [ "$variant_input" = "Official" ] || [ "$variant_input" = "MKSU" ]; then
                BRANCH_ARG="-s main"
              elif [ "$variant_input" = "Next" ]; then
                BRANCH_ARG="-s next-susfs-dev"
              else
                BRANCH_ARG="-s builtin"
              fi
              ;;
            *)
              BRANCH_ARG="-s main"
              ;;
          esac
          echo "BRANCH_ARG=${BRANCH_ARG}" >> $GITHUB_ENV

      - name: 添加 KernelSU（容错执行）
        run: |
          cd "$CONFIG" || true
          if [ "${{ inputs.kernelsu_variant }}" = "Official" ]; then
            curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash $BRANCH_ARG || true
          elif [ "${{ inputs.kernelsu_variant }}" = "Next" ]; then
            curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next-susfs/kernel/setup.sh" | bash $BRANCH_ARG || true
          elif [ "${{ inputs.kernelsu_variant }}" = "MKSU" ]; then
            curl -LSs "https://raw.githubusercontent.com/5ec1cff/KernelSU/main/kernel/setup.sh" | bash $BRANCH_ARG || true
          elif [ "${{ inputs.kernelsu_variant }}" = "SukiSU" ]; then
            curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash $BRANCH_ARG || true
          fi

      - name: (可选) 添加 Baseband-guard 支持（受 inputs.BBG 控制）
        if: ${{ inputs.BBG == 'true' || inputs.BBG == true }}
        run: |
          COMMON_DIR="$GITHUB_WORKSPACE/${CONFIG}/common"
          if [ -d "$COMMON_DIR" ]; then
            cd "$COMMON_DIR"
            wget -qO- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash || true
            CFG_FILE="arch/arm64/configs/gki_defconfig"
            if [ -f "$CFG_FILE" ]; then
              grep -q "^CONFIG_BBG" "$CFG_FILE" || echo "CONFIG_BBG=y" >> "$CFG_FILE"
            fi
          else
            echo "common dir not present; skipping BBG"
          fi

      - name: 应用其他必要补丁（zram / susfs / suki 等，容错）
        run: |
          COMMON_DIR="$GITHUB_WORKSPACE/${CONFIG}/common"
          cd "$COMMON_DIR" || exit 0
          if [ -f "$GITHUB_WORKSPACE/SukiSU_patch/other/zram/zram_patch/5.10/lz4kd.patch" ]; then
            patch -p1 -F 3 < "$GITHUB_WORKSPACE/SukiSU_patch/other/zram/zram_patch/5.10/lz4kd.patch" || true
          fi
          if [ -f "$GITHUB_WORKSPACE/susfs4ksu/kernel_patches/50_add_susfs_in_gki-android12-5.10.patch" ]; then
            patch -p1 --forward --fuzz=3 < "$GITHUB_WORKSPACE/susfs4ksu/kernel_patches/50_add_susfs_in_gki-android12-5.10.patch" || true
          fi

      - name: 固定编译时间与版本（将时间写入 mkcompile_h）
        run: |
          COMMON_DIR="$GITHUB_WORKSPACE/${CONFIG}/common"
          if [ -d "$COMMON_DIR" ]; then
            cd "$COMMON_DIR"
            CURRENT_TIME="Fri Jan 24 18:48:47 UTC 2025"
            if [ -f "./scripts/mkcompile_h" ]; then
              # 不做破坏性替换，仅在能明确识别到目标字段时替换
              perl -0777 -pe "s/(# Generated .*mkcompile_h.*?)(?=\\n)/\$1/" -i ./scripts/mkcompile_h || true
            fi
            if [ -n "${{ inputs.version }}" ]; then
              CFG="arch/arm64/configs/gki_defconfig"
              if [ -f "$CFG" ]; then
                sed -i "/^CONFIG_LOCALVERSION=/c\CONFIG_LOCALVERSION=\"${{ inputs.version }}\"" "$CFG" || true
              fi
            fi
          fi

      - name: 构建内核（带简单重试）
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE/${CONFIG}" || exit 1
          if [ -f "build/build.sh" ]; then
            if ! LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh CC="ccache clang"; then
              echo "第一次构建失败，重试一次..."
              LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh CC="ccache clang" || exit 1
            fi
          else
            echo "警告：找不到 build/build.sh，跳过构建步骤（请检查源码结构）"
            exit 0
          fi
          ccache --show-stats || true

      - name: 产物整理与打包 AnyKernel3
        run: |
          OUT_DIR="$GITHUB_WORKSPACE/${CONFIG}/out"
          if [ -d "$OUT_DIR" ]; then
            mkdir -p "$GITHUB_WORKSPACE/bootimgs" || true
            [ -f "${OUT_DIR}/android12-5.10/dist/Image" ] && cp "${OUT_DIR}/android12-5.10/dist/Image" "$GITHUB_WORKSPACE" || true
            [ -f "${OUT_DIR}/android12-5.10/dist/Image.lz4" ] && cp "${OUT_DIR}/android12-5.10/dist/Image.lz4" "$GITHUB_WORKSPACE" || true
          fi
          if [ -d "$GITHUB_WORKSPACE/AnyKernel3" ]; then
            cd "$GITHUB_WORKSPACE/AnyKernel3"
            ZIP_NAME="android12-5.10.${{ env.SUB_LEVEL }}-AnyKernel3.zip"
            if [ -f "$GITHUB_WORKSPACE/Image" ]; then
              cp "$GITHUB_WORKSPACE/Image" ./Image
              zip -r "$GITHUB_WORKSPACE/$ZIP_NAME" ./* || true
              rm -f ./Image || true
            fi
            if [ -f "$GITHUB_WORKSPACE/Image.lz4" ]; then
              cp "$GITHUB_WORKSPACE/Image.lz4" ./Image.lz4
              zip -r "$GITHUB_WORKSPACE/android12-5.10.${{ env.SUB_LEVEL }}-AnyKernel3-lz4.zip" ./* || true
              rm -f ./Image.lz4 || true
            fi
          fi

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: kernel-artifacts-5.10.226
          path: |
            android12-5.10.*AnyKernel3*.zip
            $GITHUB_WORKSPACE/Image*
            $GITHUB_WORKSPACE/bootimgs/*.img
